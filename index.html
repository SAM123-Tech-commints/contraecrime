<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contra E-Crime</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/Dccn8pc.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            display: flex;
            min-height: 100vh;
            background-color: #f4f4f4;
            position: relative;
            overflow-y: auto; 
        }

        .container {
            display: flex;
            width: 100%;
            min-height: 100vh;
            flex-direction: column; 
        }

        .background-image {
            background-image: url('https://i.imgur.com/UgM66T3.png');
            background-size: cover;
            background-position: center;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 30vh;
        }

        .background-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(88, 1, 0, 0.4), rgba(0, 0, 0, 0.3));
            z-index: 1;
        }

        .text-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background-color: transparent;
            z-index: 2;
            max-width: 90%;
        }

        .text-typewriter {
            font-size: 2vw;
            font-weight: 500;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            white-space: normal;
            overflow-wrap: break-word;
            margin: 0 auto;
            letter-spacing: .05em;
            border-right: .15em solid rgb(255, 0, 0);
            animation: blink-caret .75s step-end infinite;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: rgb(255, 0, 0); }
        }

        .website-logo {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 275px;
            height: auto;
            z-index: 2;
        }

        .form-container {
            background: #ffffff;
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 500px;
            position: relative;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            opacity: 0;
            animation: fadeIn 1s ease-in forwards;
            overflow-y: auto;
            min-height: 70vh;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .halftone-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.imgur.com/MR5VoVn.png');
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: 0; /* Ensure background stays behind form elements */
            pointer-events: none; /* Prevent background from intercepting clicks */
        }

        .logoname {
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: #580100;
            position: relative;
            z-index: 1;
        }

        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 24px;
            font-weight: 600;
            position: relative;
            z-index: 1;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
            position: relative;
            z-index: 1;
            cursor: pointer; /* Make label clickable to focus input */
        }

        .input-container {
            position: relative;
            width: 100%;
            margin-top: 5px;
            z-index: 1;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"] {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 2; /* Ensure inputs are above other elements */
            background-color: #fff; /* Ensure background is not transparent */
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus {
            border-color: #580100;
            box-shadow: 0 0 5px rgba(88, 1, 0, 0.3);
            outline: none;
            z-index: 2; /* Keep focus state above other elements */
        }

        input[readonly] {
            background-color: #ffffff;
            cursor: default; /* Corrected from 'allowed' to 'default' */
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #580100;
            transition: color 0.3s ease;
            z-index: 3; /* Ensure toggle icon is clickable */
        }

        .toggle-password:hover {
            color: #8B0000;
        }

        .checkbox-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }

        .checkbox {
            display: flex;
            align-items: center;
        }

        .checkbox input {
            margin-right: 10px;
            margin-top: 9px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            z-index: 2; /* Ensure checkbox is clickable */
        }

        .checkbox label {
            color: #580100;
            font-size: 14px;
            font-weight: 500;
            margin-left: 5px;
            margin-top: 10px;
            line-height: 18px;
            cursor: pointer;
        }

        .signup-prompt {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            color: #580100;
            position: relative;
            z-index: 1;
        }

        .signup-prompt a {
            color: #8B0000;
            text-decoration: none;
            font-weight: 600;
        }

        .signup-prompt a:hover {
            text-decoration: underline;
        }

        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .action-btn {
            padding: 12px 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #580100, #8B0000);
            color: white;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .action-btn.loading {
            pointer-events: none;
            background: linear-gradient(135deg, #8B0000, #580100);
        }

        .action-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            border: 3px solid #fff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .separator {
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
            color: #666;
            position: relative;
            z-index: 1;
        }

        .separator::before,
        .separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #ddd;
        }

        .separator::before {
            left: 0;
        }

        .separator::after {
            right: 0;
        }

        .google-btn {
            padding: 12px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            font-weight: 600;
            background: #fff;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            border-color: #580100;
        }

        .google-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .google-btn img {
            width: 20px;
            height: 20px;
        }

        .error-message {
            color: #ff0000;
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            display: none;
            position: relative;
            z-index: 1;
        }

        .error-message.show {
            display: block;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }

        .modal-content h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
        }

        @media (min-width: 769px) {
            .container {
                flex-direction: row;
            }

            .background-image {
                min-height: 100vh;
            }

            .form-container {
                min-height: 100vh;
            }

            .text-typewriter {
                font-size: 2vw;
            }
        }

        @media (max-width: 1024px) {
            .text-typewriter {
                font-size: 2.5vw;
            }

            .website-logo {
                width: 200px;
            }

            .form-container {
                padding: 30px;
            }

            .logoname {
                font-size: 28px;
            }

            h2 {
                font-size: 22px;
            }
        }

        @media (max-width: 768px) {
            .background-image {
                min-height: 40vh;
            }

            .form-container {
                max-width: 100%;
                padding: 20px;
                box-shadow: none;
            }

            .text-typewriter {
                font-size: 1.8rem;
            }

            .website-logo {
                width: 150px;
                top: 10px;
                left: 10px;
            }

            .text-container {
                padding: 10px;
            }
        }

        @media (min-width: 320px) and (max-width: 480px) {
            .background-image {
                min-height: 50vh;
            }

            .text-typewriter {
                font-size: 1.2rem;
            }

            .website-logo {
                width: 120px;
            }

            .logoname {
                font-size: 24px;
            }

            h2 {
                font-size: 20px;
            }

            .action-btn, .google-btn {
                padding: 10px 30px;
                font-size: 14px;
            }

            .form-container {
                padding: 15px;
            }

            .modal-content {
                width: 90%;
                margin: 20% auto;
            }

            .text-container {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="background-image">
            <img src="https://i.imgur.com/st5cY6l.png" alt="Website Logo" class="website-logo">
            <div class="text-container">
                <div class="text-typewriter" id="typewriterText"></div>
            </div>
        </div>
        <div class="form-container">
            <div class="halftone-background"></div>
            <div class="logoname">
                Contra E-Crime
            </div>
            <form id="loginForm">
                <h2>Log In</h2>
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="Your email here" required>
                
                <label for="login-password">Password</label>
                <div class="input-container">
                    <input type="password" id="login-password" placeholder="********" required>
                    <i class="fas fa-eye toggle-password" id="toggleLoginPassword"></i>
                </div>
                
                <div class="checkbox-container">
                    <div class="checkbox">
                        <input type="checkbox" id="rememberme">
                        <label for="rememberme">Remember Me</label>
                    </div>
                </div>

                <div class="signup-prompt">
                    Don't have an account? <a href="SignUp.html">Sign Up</a>
                </div>
                
                <div class="buttons-container">
                    <button type="submit" class="action-btn">Login</button>
                </div>
                <div class="separator">or</div>
                <div class="buttons-container">
                    <button type="button" class="google-btn" id="googleSignInBtn">
                        <img src="https://www.google.com/favicon.ico" alt="Google Icon">
                        Sign in with Google
                    </button>
                </div>
                <div class="error-message" id="loginErrorMessage"></div>
            </form>
        </div>
    </div>

    <div id="googleSignInModal" class="modal">
        <div class="modal-content">
            <span class="close-btn">×</span>
            <h2>Sign Up with Google</h2>
            <form id="googleSignInForm">
                <label for="google-email">Email (read-only)</label>
                <input type="email" id="google-email" readonly required>
                
                <label for="google-username">Username</label>
                <input type="text" id="google-username" placeholder="Enter your username" required>
                
                <label for="google-password">Password</label>
                <div class="input-container">
                    <input type="password" id="google-password" placeholder="Enter your password" required>
                    <i class="fas fa-eye toggle-password" id="toggleGooglePassword"></i>
                </div>
                
                <div class="buttons-container">
                    <button type="submit" class="action-btn">Sign Up</button>
                </div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-database-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCDNmxNOV7rr_qfM_mTeYTaUIkkLvRaf80",
            authDomain: "contra-e-crime.firebaseapp.com",
            databaseURL: "https://contra-e-crime-default-rtdb.firebaseio.com",
            projectId: "contra-e-crime",
            storageBucket: "contra-e-crime.firebasestorage.app",
            messagingSenderId: "198995444405",
            appId: "1:198995444405:web:5f8c6eed561461b36034fc",
            measurementId: "G-7Y2E24DD42"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.database();

        // Check if user is already logged in
        auth.onAuthStateChanged((user) => {
            if (user) {
                window.location.href = "HomePage.html";
            }
        });

        async function logLoginEvent(userEmail) {
            try {
                const timestamp = new Date().toISOString();
                await db.ref('loginEvents').push({
                    userEmail: userEmail,
                    timestamp: timestamp
                });
                console.log('Login event logged for:', userEmail);
            } catch (error) {
                console.error('Error logging login event:', error);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            try {
                const toggleLoginPassword = document.querySelector('#toggleLoginPassword');
                const loginPassword = document.querySelector('#login-password');

                if (toggleLoginPassword && loginPassword) {
                    toggleLoginPassword.addEventListener('click', function () {
                        const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                        loginPassword.setAttribute('type', type);
                        this.classList.toggle('fa-eye-slash');
                    });
                }

                const toggleGooglePassword = document.querySelector('#toggleGooglePassword');
                const googlePassword = document.querySelector('#google-password');

                if (toggleGooglePassword && googlePassword) {
                    toggleGooglePassword.addEventListener('click', function () {
                        const type = googlePassword.getAttribute('type') === 'password' ? 'text' : 'password';
                        googlePassword.setAttribute('type', type);
                        this.classList.toggle('fa-eye-slash');
                    });
                }

                // Ensure inputs are clickable by adding a click handler to labels
                document.querySelectorAll('label[for]').forEach(label => {
                    label.addEventListener('click', () => {
                        const input = document.getElementById(label.getAttribute('for'));
                        if (input) {
                            input.focus();
                        }
                    });
                });

                const loginForm = document.getElementById('loginForm');
                const loginErrorMessage = document.getElementById('loginErrorMessage');

                if (loginForm) {
                    loginForm.addEventListener('submit', async (event) => {
                        event.preventDefault();

                        const submitButton = loginForm.querySelector('.action-btn');
                        submitButton.classList.add('loading');
                        submitButton.disabled = true;

                        try {
                            const email = document.getElementById('login-email').value.trim();
                            const passwordValue = loginPassword.value.trim();
                            const rememberMe = document.getElementById('rememberme').checked;

                            // Sign in with Firebase Authentication
                            await auth.signInWithEmailAndPassword(email, passwordValue);

                            // Log login event
                            await logLoginEvent(email);

                            // Set persistence based on "Remember Me"
                            if (rememberMe) {
                                await auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
                            } else {
                                await auth.setPersistence(firebase.auth.Auth.Persistence.SESSION);
                            }

                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;

                            // Redirect to HomePage.html
                            window.location.href = "HomePage.html";
                        } catch (error) {
                            console.error('Login error:', error);
                            loginErrorMessage.style.display = 'block';
                            loginErrorMessage.classList.add('show');
                            loginErrorMessage.textContent = error.message;
                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                        }
                    });
                }

                const googleSignInBtn = document.getElementById('googleSignInBtn');
                const googleSignInModal = document.getElementById('googleSignInModal');
                const googleSignInForm = document.getElementById('googleSignInForm');
                const closeBtn = googleSignInModal.querySelector('.close-btn');
                let googleUserData = null;

                if (googleSignInBtn) {
                    googleSignInBtn.addEventListener('click', () => {
                        googleSignInBtn.classList.add('loading');
                        const provider = new firebase.auth.GoogleAuthProvider();
                        auth.signInWithPopup(provider)
                            .then(async (result) => {
                                googleSignInBtn.classList.remove('loading');
                                const user = result.user;
                                googleUserData = {
                                    email: user.email,
                                    username: user.displayName || 'Google User'
                                };

                                const userRef = db.ref('users/' + user.uid);
                                userRef.once('value', (snapshot) => {
                                    if (snapshot.exists()) {
                                        // User exists, redirect to homepage
                                        logLoginEvent(googleUserData.email);
                                        window.location.href = "HomePage.html";
                                    } else {
                                        // New user, show modal to complete profile
                                        document.getElementById('google-email').value = googleUserData.email;
                                        document.getElementById('google-username').value = googleUserData.username;
                                        googleSignInModal.style.display = 'block';
                                    }
                                });
                            })
                            .catch((error) => {
                                googleSignInBtn.classList.remove('loading');
                                loginErrorMessage.style.display = 'block';
                                loginErrorMessage.classList.add('show');
                                loginErrorMessage.textContent = 'Google Sign-In failed: ' + error.message;
                            });
                    });
                }

                if (googleSignInForm) {
                    googleSignInForm.addEventListener('submit', async (event) => {
                        event.preventDefault();

                        const submitButton = googleSignInForm.querySelector('.action-btn');
                        submitButton.classList.add('loading');
                        submitButton.disabled = true;

                        try {
                            const email = document.getElementById('google-email').value.trim();
                            const username = document.getElementById('google-username').value.trim();
                            const password = document.getElementById('google-password').value.trim();

                            if (!username) {
                                loginErrorMessage.style.display = 'block';
                                loginErrorMessage.classList.add('show');
                                loginErrorMessage.textContent = 'Please enter a username.';
                                submitButton.classList.remove('loading');
                                submitButton.disabled = false;
                                return;
                            }

                            if (!password) {
                                loginErrorMessage.style.display = 'block';
                                loginErrorMessage.classList.add('show');
                                loginErrorMessage.textContent = 'Please enter a password.';
                                submitButton.classList.remove('loading');
                                submitButton.disabled = false;
                                return;
                            }

                            const user = auth.currentUser;
                            if (user) {
                                // Save user data to Realtime Database
                                await db.ref('users/' + user.uid).set({
                                    email: email,
                                    username: username,
                                    password: password,
                                    createdAt: new Date().toISOString()
                                });

                                await logLoginEvent(email);

                                submitButton.classList.remove('loading');
                                submitButton.disabled = false;
                                googleSignInModal.style.display = 'none';

                                window.location.href = "HomePage.html";
                            } else {
                                throw new Error('User not authenticated');
                            }
                        } catch (error) {
                            console.error('Google Sign-In submission error:', error);
                            loginErrorMessage.style.display = 'block';
                            loginErrorMessage.classList.add('show');
                            loginErrorMessage.textContent = 'An error occurred during sign-up. Please try again.';
                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                        }
                    });
                }

                if (closeBtn) {
                    closeBtn.addEventListener('click', () => {
                        googleSignInModal.style.display = 'none';
                        googleUserData = null;
                    });

                    window.addEventListener('click', (event) => {
                        if (event.target === googleSignInModal) {
                            googleSignInModal.style.display = 'none';
                            googleUserData = null;
                        }
                    });
                }

                const phrases = [
                    "Protect yourself from cybercrime today.",
                    "Contra E-Crime: Your shield online.",
                    "Stay safe, stay informed, stay secure.",
                    "A righteous one deserves a precise outcome.",
                    "Empowering you against digital threats.",
                    "I’m here to help you navigate cybercrime laws.",
                    "Let’s find the legal answers you need, fast.",
                    "Your trusted guide to cybercrime justice.",
                    "Uncover the law, defeat the threat.",
                    "Defending your digital rights, step by step."
                ];
                const typewriterText = document.getElementById('typewriterText');
                let currentPhraseIndex = 0;
                let charIndex = 0;
                let isDeleting = false;

                function typeWriter() {
                    const currentPhrase = phrases[currentPhraseIndex];

                    if (!isDeleting) {
                        if (charIndex < currentPhrase.length) {
                            typewriterText.innerHTML = currentPhrase.substring(0, charIndex + 1);
                            charIndex++;
                            setTimeout(typeWriter, 100);
                        } else {
                            setTimeout(() => {
                                isDeleting = true;
                                typeWriter();
                            }, 2000);
                        }
                    } else {
                        if (charIndex > 0) {
                            typewriterText.innerHTML = currentPhrase.substring(0, charIndex - 1);
                            charIndex--;
                            setTimeout(typeWriter, 50);
                        } else {
                            isDeleting = false;
                            currentPhraseIndex = (currentPhraseIndex + 1) % phrases.length;
                            setTimeout(typeWriter, 500);
                        }
                    }
                }

                if (typewriterText) {
                    typeWriter();
                }
            } catch (error) {
                console.error('An error occurred in the script:', error);
            }
        });
    </script>
</body>
</html>