<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Contra E-Crime</title>
    <link rel="icon" type="image/png" href="https://i.imgur.com/Dccn8pc.png">
    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Montserrat', sans-serif;
            display: flex;
            min-height: 100vh;
            background-color: #f4f4f4;
            position: relative;
            overflow-y: auto;
        }

        .container {
            display: flex;
            width: 100%;
            min-height: 100vh;
            flex-direction: column;
        }

        .background-image {
            background-image: url('https://i.imgur.com/UgM66T3.png');
            background-size: cover;
            background-position: center;
            flex: 1;
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            min-height: 30vh;
        }

        .background-image::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: linear-gradient(135deg, rgba(88, 1, 0, 0.4), rgba(0, 0, 0, 0.3));
            z-index: 1;
        }

        .text-container {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            text-align: center;
            padding: 20px;
            border-radius: 10px;
            background-color: transparent;
            z-index: 2;
            max-width: 90%;
            overflow: hidden;
        }

        .text-typewriter {
            font-size: 2vw;
            font-weight: 500;
            color: #fff;
            font-family: 'Montserrat', sans-serif;
            overflow: hidden;
            white-space: nowrap;
            margin: 0 auto;
            letter-spacing: .05em;
            border-right: .15em solid rgb(255, 0, 0);
            animation: blink-caret .75s step-end infinite;
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.3);
        }

        @keyframes blink-caret {
            from, to { border-color: transparent }
            50% { border-color: rgb(255, 0, 0); }
        }

        .website-logo {
            position: absolute;
            top: 20px;
            left: 20px;
            width: 275px;
            height: auto;
            z-index: 2;
        }

        .form-container {
            background: #ffffff;
            flex: 1;
            padding: 40px;
            display: flex;
            flex-direction: column;
            justify-content: center;
            max-width: 500px;
            position: relative;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            opacity: 0;
            animation: fadeIn 1s ease-in forwards;
            overflow-y: auto;
            min-height: 70vh;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .halftone-background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-image: url('https://i.imgur.com/MR5VoVn.png');
            background-size: cover;
            background-position: center;
            opacity: 0.3;
            z-index: 0;
            pointer-events: none;
        }

        .logoname {
            font-size: 36px;
            font-weight: 700;
            text-align: center;
            margin-bottom: 20px;
            color: #580100;
            position: relative;
            z-index: 1;
        }

        h2 {
            text-align: center;
            margin-bottom: 25px;
            color: #333;
            font-size: 24px;
            font-weight: 500;
            position: relative;
            z-index: 1;
        }

        label {
            display: block;
            margin-top: 15px;
            font-weight: 500;
            color: #333;
            font-size: 14px;
            position: relative;
            z-index: 1;
            cursor: pointer;
        }

        .input-container {
            position: relative;
            width: 100%;
            margin-top: 5px;
            z-index: 1;
        }

        input[type="text"],
        input[type="password"],
        input[type="email"] {
            width: 100%;
            padding: 12px;
            margin-top: 5px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-family: 'Montserrat', sans-serif;
            font-size: 14px;
            transition: border-color 0.3s ease, box-shadow 0.3s ease;
            position: relative;
            z-index: 2;
            background-color: #fff;
        }

        input[type="text"]:focus,
        input[type="password"]:focus,
        input[type="email"]:focus {
            border-color: #580100;
            box-shadow: 0 0 5px rgba(88, 1, 0, 0.3);
            outline: none;
            z-index: 2;
        }

        input[readonly] {
            background-color: #ffffff;
            cursor: default;
        }

        .toggle-password {
            position: absolute;
            right: 10px;
            top: 50%;
            transform: translateY(-50%);
            cursor: pointer;
            color: #580100;
            transition: color 0.3s ease;
            z-index: 3;
        }

        .toggle-password:hover {
            color: #8B0000;
        }

        .checkbox-container {
            display: flex;
            justify-content: flex-start;
            align-items: center;
            margin: 15px 0;
            position: relative;
            z-index: 1;
        }

        .checkbox {
            display: flex;
            align-items: center;
        }

        .checkbox input {
            margin-right: 10px;
            margin-top: 9px;
            width: 18px;
            height: 18px;
            cursor: pointer;
            z-index: 2;
        }

        .checkbox label {
            color: #580100;
            font-size: 14px;
            font-weight: 500;
            margin-left: 5px;
            margin-top: 10px;
            line-height: 18px;
            cursor: pointer;
        }

        .forgot-password {
            text-align: right;
            margin-top: 10px;
            font-size: 14px;
            position: relative;
            z-index: 1;
        }

        .forgot-password a {
            color: #8B0000;
            text-decoration: none;
            font-weight: 600;
        }

        .forgot-password a:hover {
            text-decoration: underline;
        }

        .signup-prompt {
            text-align: center;
            margin: 20px 0;
            font-size: 14px;
            color: #580100;
            position: relative;
            z-index: 1;
        }

        .signup-prompt a {
            color: #8B0000;
            text-decoration: none;
            font-weight: 600;
        }

        .signup-prompt a:hover {
            text-decoration: underline;
        }

        .buttons-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin-top: 20px;
            position: relative;
            z-index: 1;
        }

        .action-btn {
            padding: 12px 40px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            font-weight: 600;
            background: linear-gradient(135deg, #580100, #8B0000);
            color: white;
            position: relative;
            transition: transform 0.2s ease, box-shadow 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
        }

        .action-btn.loading {
            pointer-events: none;
            background: linear-gradient(135deg, #8B0000, #580100);
        }

        .action-btn.loading::after {
            content: '';
            position: absolute;
            width: 20px;
            height: 20px;
            top: 50%;
            right: 10px;
            transform: translateY(-50%);
            border: 3px solid #fff;
            border-top: 3px solid transparent;
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: translateY(-50%) rotate(0deg); }
            100% { transform: translateY(-50%) rotate(360deg); }
        }

        .separator {
            text-align: center;
            margin: 15px 0;
            font-size: 14px;
            color: #666;
            position: relative;
            z-index: 1;
        }

        .separator::before,
        .separator::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #ddd;
        }

        .separator::before {
            left: 0;
        }

        .separator::after {
            right: 0;
        }

        .google-btn {
            padding: 12px 40px;
            border: 1px solid #ddd;
            border-radius: 8px;
            cursor: pointer;
            font-family: 'Montserrat', sans-serif;
            font-size: 16px;
            font-weight: 600;
            background: #fff;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
            transition: transform 0.2s ease, box-shadow 0.3s ease, border-color 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            z-index: 1;
        }

        .google-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 10px rgba(0, 0, 0, 0.2);
            border-color: #580100;
        }

        .google-btn.loading {
            pointer-events: none;
            opacity: 0.7;
        }

        .google-btn img {
            width: 20px;
            height: 20px;
        }

        .error-message,
        .success-message {
            text-align: center;
            margin-top: 10px;
            font-size: 14px;
            display: none;
            position: relative;
            z-index: 1;
        }

        .error-message {
            color: #ff0000;
        }

        .success-message {
            color: #28a745;
        }

        .error-message.show,
        .success-message.show {
            display: block;
            animation: shake 0.5s ease;
        }

        @keyframes shake {
            0%, 100% { transform: translateX(0); }
            10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
            20%, 40%, 60%, 80% { transform: translateX(5px); }
        }

        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
        }

        .modal-content {
            background-color: #fff;
            margin: 15% auto;
            padding: 20px;
            border: 1px solid #888;
            width: 80%;
            max-width: 500px;
            border-radius: 10px;
            position: relative;
        }

        .modal-content h2 {
            font-size: 20px;
            margin-bottom: 15px;
        }

        .close-btn {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-btn:hover,
        .close-btn:focus {
            color: #000;
            text-decoration: none;
        }

        .back-to-login {
            text-align: center;
            margin-top: 20px;
            font-size: 14px;
            color: #580100;
            position: relative;
            z-index: 1;
        }

        .back-to-login a {
            color: #8B0000;
            text-decoration: none;
            font-weight: 600;
        }

        .back-to-login a:hover {
            text-decoration: underline;
        }

        @media (min-width: 769px) {
            body {
                overflow-y: hidden;
            }

            .container {
                flex-direction: row;
                height: 100vh;
            }

            .background-image {
                min-height: 100vh;
                height: 100vh;
            }

            .form-container {
                min-height: 100vh;
                height: 100vh;
                overflow-y: hidden;
            }

            .text-typewriter {
                font-size: 2vw;
            }
        }

        @media (max-width: 1024px) {
            .text-typewriter {
                font-size: 2.5vw;
            }

            .website-logo {
                width: 200px;
            }

            .form-container {
                padding: 30px;
            }

            .logoname {
                font-size: 28px;
            }

            h2 {
                font-size: 22px;
            }
        }

        @media (max-width: 768px) {
            .background-image {
                min-height: 40vh;
            }

            .form-container {
                max-width: 100%;
                padding: 20px;
                box-shadow: none;
                min-height: auto;
            }

            .text-typewriter {
                font-size: 1.8rem;
            }

            .website-logo {
                width: 150px;
                top: 10px;
                left: 10px;
            }

            .text-container {
                padding: 10px;
            }
        }

        @media (min-width: 320px) and (max-width: 480px) {
            body {
                overflow-y: auto;
            }

            .container {
                min-height: 100vh;
                height: auto;
                overflow: visible;
            }

            .background-image {
                min-height: 30vh;
                height: 30vh;
                padding-top: 10px;
            }

            .form-container {
                padding: 10px;
                min-height: 70vh;
                height: auto;
                overflow-y: visible;
                display: flex;
                flex-direction: column;
                justify-content: flex-start;
            }

            .text-typewriter {
                font-size: 0.9rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
            }

            .website-logo {
                width: 100px;
                top: 5px;
                left: 5px;
            }

            .logoname {
                font-size: 20px;
                margin-bottom: 10px;
            }

            h2 {
                font-size: 18px;
                margin-bottom: 15px;
            }

            label {
                margin-top: 10px;
                font-size: 12px;
            }

            input[type="text"],
            input[type="password"],
            input[type="email"] {
                padding: 8px;
                font-size: 12px;
            }

            .checkbox-container {
                margin: 10px 0;
            }

            .checkbox label {
                font-size: 12px;
                margin-top: 5px;
            }

            .forgot-password,
            .signup-prompt,
            .back-to-login {
                font-size: 12px;
                margin: 10px 0;
            }

            .action-btn,
            .google-btn {
                padding: 8px 16px;
                font-size: 12px;
            }

            .separator {
                margin: 10px 0;
                font-size: 12px;
            }

            .modal-content {
                width: 90%;
                margin: 10% auto;
                padding: 10px;
            }

            .text-container {
                padding: 5px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="background-image">
            <img src="https://i.imgur.com/st5cY6l.png" alt="Website Logo" class="website-logo">
            <div class="text-container">
                <div class="text-typewriter" id="typewriterText"></div>
            </div>
        </div>
        <div class="form-container">
            <div class="halftone-background"></div>
            <div class="logoname">
                Contra E-Crime
            </div>
            <!-- Login Form -->
            <form id="loginForm" style="display: none;">
                <h2>Log In</h2>
                <label for="login-email">Email</label>
                <input type="email" id="login-email" placeholder="Your email here" required>
                
                <label for="login-password">Password</label>
                <div class="input-container">
                    <input type="password" id="login-password" placeholder="********" required>
                    <i class="fas fa-eye toggle-password" id="toggleLoginPassword"></i>
                </div>
                
                <div class="forgot-password">
                    <a href="#" id="forgotPasswordLink">Forgot Password?</a>
                </div>
                
                <div class="checkbox-container">
                    <div class="checkbox">
                        <input type="checkbox" id="rememberme">
                        <label for="rememberme">Remember Me</label>
                    </div>
                </div>

                <div class="signup-prompt">
                    Don't have an account? <a href="SignUp.html">Sign Up</a>
                </div>
                
                <div class="buttons-container">
                    <button type="submit" class="action-btn">Login</button>
                </div>
                <div class="separator">or</div>
                <div class="buttons-container">
                    <button type="button" class="google-btn" id="googleSignInBtn">
                        <img src="https://www.google.com/favicon.ico" alt="Google Icon">
                        Sign in with Google
                    </button>
                </div>
                <div class="error-message" id="loginErrorMessage"></div>
            </form>

            <!-- Reset Password Form -->
            <form id="resetPasswordForm" style="display: none;">
                <h2>Reset Password</h2>
                <label for="new-username">New Username (Optional)</label>
                <input type="text" id="new-username" placeholder="Enter new username (optional)">
                
                <label for="new-password">New Password</label>
                <div class="input-container">
                    <input type="password" id="new-password" placeholder="Enter new password" required>
                    <i class="fas fa-eye toggle-password" id="toggleNewPassword"></i>
                </div>
                
                <label for="confirm-password">Confirm Password</label>
                <div class="input-container">
                    <input type="password" id="confirm-password" placeholder="Confirm new password" required>
                    <i class="fas fa-eye toggle-password" id="toggleConfirmPassword"></i>
                </div>
                
                <div class="buttons-container">
                    <button type="submit" class="action-btn">Reset Password</button>
                </div>
                <div class="error-message" id="resetErrorMessage"></div>
                <div class="success-message" id="resetSuccessMessage"></div>
                <div class="back-to-login">
                    <a href="index.html">Back to Login</a>
                </div>
            </form>
        </div>
    </div>

    <div id="googleSignInModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeGoogleModal">×</span>
            <h2>Sign Up with Google</h2>
            <form id="googleSignInForm">
                <label for="google-email">Email (read-only)</label>
                <input type="email" id="google-email" readonly required>
                
                <label for="google-username">Username</label>
                <input type="text" id="google-username" placeholder="Enter your username" required>
                
                <label for="google-password">Password</label>
                <div class="input-container">
                    <input type="password" id="google-password" placeholder="Enter your password" required>
                    <i class="fas fa-eye toggle-password" id="toggleGooglePassword"></i>
                </div>
                
                <div class="buttons-container">
                    <button type="submit" class="action-btn">Sign Up</button>
                </div>
                <div class="error-message" id="googleErrorMessage"></div>
            </form>
        </div>
    </div>

    <div id="forgotPasswordModal" class="modal">
        <div class="modal-content">
            <span class="close-btn" id="closeForgotPasswordModal">×</span>
            <h2>Reset Password</h2>
            <form id="forgotPasswordForm">
                <label for="forgot-email">Email</label>
                <input type="email" id="forgot-email" placeholder="Enter your email" required>
                
                <div class="buttons-container">
                    <button type="submit" class="action-btn">Send Reset Link</button>
                </div>
                <div class="error-message" id="forgotErrorMessage"></div>
                <div class="success-message" id="forgotSuccessMessage"></div>
            </form>
        </div>
    </div>

    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore-compat.js"></script>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyCDNmxNOV7rr_qfM_mTeYTaUIkkLvRaf80",
            authDomain: "contra-e-crime.firebaseapp.com",
            projectId: "contra-e-crime",
            storageBucket: "contra-e-crime.firebasestorage.app",
            messagingSenderId: "198995444405",
            appId: "1:198995444405:web:5f8c6eed561461b36034fc",
            measurementId: "G-7Y2E24DD42"
        };

        const app = firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        async function logLoginEvent(userEmail) {
            try {
                const timestamp = firebase.firestore.FieldValue.serverTimestamp();
                await db.collection('loginEvents').add({
                    userEmail: userEmail,
                    timestamp: timestamp
                });
                console.log('Login event logged for:', userEmail);
            } catch (error) {
                console.error('Error logging login event:', error);
                throw error;
            }
        }

        document.addEventListener('DOMContentLoaded', function () {
            try {
                // Check if we're in reset password mode
                const urlParams = new URLSearchParams(window.location.search);
                const mode = urlParams.get('mode');
                const oobCode = urlParams.get('oobCode');

                const loginForm = document.getElementById('loginForm');
                const resetPasswordForm = document.getElementById('resetPasswordForm');

                if (mode === 'resetPassword' && oobCode) {
                    loginForm.style.display = 'none';
                    resetPasswordForm.style.display = 'block';
                } else {
                    loginForm.style.display = 'block';
                    resetPasswordForm.style.display = 'none';
                }

                // Password toggle for login form
                const toggleLoginPassword = document.querySelector('#toggleLoginPassword');
                const loginPassword = document.querySelector('#login-password');

                if (toggleLoginPassword && loginPassword) {
                    toggleLoginPassword.addEventListener('click', function () {
                        const type = loginPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                        loginPassword.setAttribute('type', type);
                        this.classList.toggle('fa-eye-slash');
                    });
                }

                // Password toggle for Google sign-in form
                const toggleGooglePassword = document.querySelector('#toggleGooglePassword');
                const googlePassword = document.querySelector('#google-password');

                if (toggleGooglePassword && googlePassword) {
                    toggleGooglePassword.addEventListener('click', function () {
                        const type = googlePassword.getAttribute('type') === 'password' ? 'text' : 'password';
                        googlePassword.setAttribute('type', type);
                        this.classList.toggle('fa-eye-slash');
                    });
                }

                // Password toggle for new password in reset form
                const toggleNewPassword = document.querySelector('#toggleNewPassword');
                const newPassword = document.querySelector('#new-password');

                if (toggleNewPassword && newPassword) {
                    toggleNewPassword.addEventListener('click', function () {
                        const type = newPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                        newPassword.setAttribute('type', type);
                        this.classList.toggle('fa-eye-slash');
                    });
                }

                // Password toggle for confirm password in reset form
                const toggleConfirmPassword = document.querySelector('#toggleConfirmPassword');
                const confirmPassword = document.querySelector('#confirm-password');

                if (toggleConfirmPassword && confirmPassword) {
                    toggleConfirmPassword.addEventListener('click', function () {
                        const type = confirmPassword.getAttribute('type') === 'password' ? 'text' : 'password';
                        confirmPassword.setAttribute('type', type);
                        this.classList.toggle('fa-eye-slash');
                    });
                }

                // Make labels focus inputs when clicked
                document.querySelectorAll('label[for]').forEach(label => {
                    label.addEventListener('click', () => {
                        const input = document.getElementById(label.getAttribute('for'));
                        if (input) {
                            input.focus();
                        }
                    });
                });

                // Login form submission
                if (loginForm) {
                    loginForm.addEventListener('submit', async (event) => {
                        event.preventDefault();

                        const submitButton = loginForm.querySelector('.action-btn');
                        submitButton.classList.add('loading');
                        submitButton.disabled = true;

                        try {
                            const email = document.getElementById('login-email').value.trim();
                            const passwordValue = loginPassword.value.trim();
                            const rememberMe = document.getElementById('rememberme').checked;
                            const loginErrorMessage = document.getElementById('loginErrorMessage');

                            // Validate password format before attempting login
                            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                            if (!passwordRegex.test(passwordValue)) {
                                loginErrorMessage.style.display = 'block';
                                loginErrorMessage.classList.add('show');
                                loginErrorMessage.textContent = 'Password must be at least 8 characters long and include uppercase, lowercase, numbers, and special characters (e.g., @$!%*?&).';
                                submitButton.classList.remove('loading');
                                submitButton.disabled = false;
                                return;
                            }

                            // Use Firebase Authentication for login
                            await auth.signInWithEmailAndPassword(email, passwordValue);

                            await logLoginEvent(email);

                            const userDoc = await db.collection('users').doc(email).get();
                            const username = userDoc.exists ? userDoc.data().username : 'User';

                            localStorage.setItem('currentUser', JSON.stringify({ email, username }));

                            if (rememberMe) {
                                localStorage.setItem('rememberMe', 'true');
                            } else {
                                localStorage.removeItem('rememberMe');
                            }

                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;

                            window.location.href = "HomePage.html";
                        } catch (error) {
                            console.error('Login error:', error);
                            const loginErrorMessage = document.getElementById('loginErrorMessage');
                            loginErrorMessage.style.display = 'block';
                            loginErrorMessage.classList.add('show');
                            switch (error.code) {
                                case 'auth/user-not-found':
                                    loginErrorMessage.textContent = 'Email not found. Please sign up.';
                                    break;
                                case 'auth/wrong-password':
                                    loginErrorMessage.textContent = 'Incorrect password. Please try again.';
                                    break;
                                case 'auth/invalid-email':
                                    loginErrorMessage.textContent = 'Invalid email format. Please check your email.';
                                    break;
                                case 'auth/too-many-requests':
                                    loginErrorMessage.textContent = 'Too many login attempts. Please try again later.';
                                    break;
                                default:
                                    loginErrorMessage.textContent = 'An error occurred during login. Please try again.';
                            }
                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                        }
                    });
                }

                // Reset password form submission
                if (resetPasswordForm) {
                    resetPasswordForm.addEventListener('submit', async (event) => {
                        event.preventDefault();

                        const submitButton = resetPasswordForm.querySelector('.action-btn');
                        submitButton.classList.add('loading');
                        submitButton.disabled = true;

                        const newUsername = document.getElementById('new-username').value.trim();
                        const newPasswordValue = document.getElementById('new-password').value.trim();
                        const confirmPasswordValue = document.getElementById('confirm-password').value.trim();
                        const resetErrorMessage = document.getElementById('resetErrorMessage');
                        const resetSuccessMessage = document.getElementById('resetSuccessMessage');

                        // Validate passwords match
                        if (newPasswordValue !== confirmPasswordValue) {
                            resetErrorMessage.textContent = 'Passwords do not match.';
                            resetErrorMessage.style.display = 'block';
                            resetErrorMessage.classList.add('show');
                            resetSuccessMessage.style.display = 'none';
                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                            return;
                        }

                        // Validate password strength
                        const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                        if (!passwordRegex.test(newPasswordValue)) {
                            resetErrorMessage.textContent = 'Password is incorrect. It must be at least 8 characters long and include uppercase, lowercase, numbers, and special characters (e.g., @$!%*?&).';
                            resetErrorMessage.style.display = 'block';
                            resetErrorMessage.classList.add('show');
                            resetSuccessMessage.style.display = 'none';
                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                            return;
                        }

                        try {
                            // Verify the reset code and get the user's email
                            const email = await auth.verifyPasswordResetCode(oobCode);

                            // Confirm the new password
                            await auth.confirmPasswordReset(oobCode, newPasswordValue);

                            // If a new username is provided, update it in Firestore
                            if (newUsername) {
                                await db.collection('users').doc(email).update({
                                    username: newUsername,
                                    updatedAt: firebase.firestore.FieldValue.serverTimestamp()
                                });

                                // Update localStorage if the user is logged in
                                const currentUser = JSON.parse(localStorage.getItem('currentUser'));
                                if (currentUser && currentUser.email === email) {
                                    localStorage.setItem('currentUser', JSON.stringify({ email, username: newUsername }));
                                }
                            }

                            resetSuccessMessage.textContent = 'Password reset successful! Redirecting to login...';
                            resetSuccessMessage.style.display = 'block';
                            resetSuccessMessage.classList.add('show');
                            resetErrorMessage.style.display = 'none';

                            // Redirect to login form after 3 seconds
                            setTimeout(() => {
                                window.location.href = 'index.html';
                            }, 3000);
                        } catch (error) {
                            console.error('Password reset error:', error);
                            resetErrorMessage.textContent = error.message.includes('expired') || error.message.includes('invalid')
                                ? 'The reset link has expired or is invalid. Please request a new one.'
                                : 'An error occurred. Please try again: ' + error.message;
                            resetErrorMessage.style.display = 'block';
                            resetErrorMessage.classList.add('show');
                            resetSuccessMessage.style.display = 'none';
                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                        }
                    });
                }

                // Google sign-in button
                const googleSignInBtn = document.getElementById('googleSignInBtn');
                const googleSignInModal = document.getElementById('googleSignInModal');
                const googleSignInForm = document.getElementById('googleSignInForm');
                const googleErrorMessage = document.getElementById('googleErrorMessage');
                const closeGoogleModal = document.getElementById('closeGoogleModal');
                let googleUserData = null;

                if (googleSignInBtn) {
                    googleSignInBtn.addEventListener('click', () => {
                        googleSignInBtn.classList.add('loading');
                        const provider = new firebase.auth.GoogleAuthProvider();
                        auth.signInWithPopup(provider)
                            .then(async (result) => {
                                googleSignInBtn.classList.remove('loading');
                                const user = result.user;
                                googleUserData = {
                                    email: user.email,
                                    username: user.displayName || 'Google User'
                                };

                                const userDoc = await db.collection('users').doc(googleUserData.email).get();
                                if (userDoc.exists) {
                                    await logLoginEvent(googleUserData.email);
                                    localStorage.setItem('currentUser', JSON.stringify({
                                        email: userDoc.data().email,
                                        username: userDoc.data().username
                                    }));
                                    localStorage.setItem('rememberMe', 'true');
                                    window.location.href = "HomePage.html";
                                } else {
                                    document.getElementById('google-email').value = googleUserData.email;
                                    document.getElementById('google-username').value = googleUserData.username;
                                    googleSignInModal.style.display = 'block';
                                }
                            })
                            .catch((error) => {
                                googleSignInBtn.classList.remove('loading');
                                const loginErrorMessage = document.getElementById('loginErrorMessage');
                                loginErrorMessage.style.display = 'block';
                                loginErrorMessage.classList.add('show');
                                loginErrorMessage.textContent = 'Google Sign-In failed: ' + error.message;
                            });
                    });
                }

                // Google sign-in form submission
                if (googleSignInForm) {
                    googleSignInForm.addEventListener('submit', async (event) => {
                        event.preventDefault();

                        const submitButton = googleSignInForm.querySelector('.action-btn');
                        submitButton.classList.add('loading');
                        submitButton.disabled = true;

                        try {
                            const email = document.getElementById('google-email').value.trim();
                            const username = document.getElementById('google-username').value.trim();
                            const password = document.getElementById('google-password').value.trim();

                            if (!username) {
                                googleErrorMessage.style.display = 'block';
                                googleErrorMessage.classList.add('show');
                                googleErrorMessage.textContent = 'Please enter a username.';
                                submitButton.classList.remove('loading');
                                submitButton.disabled = false;
                                return;
                            }

                            if (!password) {
                                googleErrorMessage.style.display = 'block';
                                googleErrorMessage.classList.add('show');
                                googleErrorMessage.textContent = 'Please enter a password.';
                                submitButton.classList.remove('loading');
                                submitButton.disabled = false;
                                return;
                            }

                            const passwordRegex = /^(?=.*[a-z])(?=.*[A-Z])(?=.*\d)(?=.*[@$!%*?&])[A-Za-z\d@$!%*?&]{8,}$/;
                            if (!passwordRegex.test(password)) {
                                googleErrorMessage.style.display = 'block';
                                googleErrorMessage.classList.add('show');
                                googleErrorMessage.textContent = 'Password is incorrect. It must be at least 8 characters long and include uppercase, lowercase, numbers, and special characters (e.g., @$!%*?&).';
                                submitButton.classList.remove('loading');
                                submitButton.disabled = false;
                                return;
                            }

                            await db.collection('users').doc(email).set({
                                email: email,
                                username: username,
                                createdAt: firebase.firestore.FieldValue.serverTimestamp()
                            });

                            await logLoginEvent(email);

                            localStorage.setItem('currentUser', JSON.stringify({ email, username }));
                            localStorage.setItem('rememberMe', 'true');

                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                            googleSignInModal.style.display = 'none';

                            window.location.href = "HomePage.html";
                        } catch (error) {
                            console.error('Google Sign-In submission error:', error);
                            googleErrorMessage.style.display = 'block';
                            googleErrorMessage.classList.add('show');
                            googleErrorMessage.textContent = 'An error occurred during sign-up. Please try again.';
                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                        }
                    });
                }

                // Close Google sign-in modal
                if (closeGoogleModal) {
                    closeGoogleModal.addEventListener('click', () => {
                        googleSignInModal.style.display = 'none';
                        googleUserData = null;
                    });

                    window.addEventListener('click', (event) => {
                        if (event.target === googleSignInModal) {
                            googleSignInModal.style.display = 'none';
                            googleUserData = null;
                        }
                    });
                }

                // Forgot password functionality
                const forgotPasswordLink = document.getElementById('forgotPasswordLink');
                const forgotPasswordModal = document.getElementById('forgotPasswordModal');
                const forgotPasswordForm = document.getElementById('forgotPasswordForm');
                const forgotErrorMessage = document.getElementById('forgotErrorMessage');
                const forgotSuccessMessage = document.getElementById('forgotSuccessMessage');
                const closeForgotPasswordModal = document.getElementById('closeForgotPasswordModal');

                if (forgotPasswordLink) {
                    forgotPasswordLink.addEventListener('click', (event) => {
                        event.preventDefault();
                        forgotPasswordModal.style.display = 'block';
                    });
                }

                if (forgotPasswordForm) {
                    forgotPasswordForm.addEventListener('submit', async (event) => {
                        event.preventDefault();

                        const submitButton = forgotPasswordForm.querySelector('.action-btn');
                        submitButton.classList.add('loading');
                        submitButton.disabled = true;

                        const email = document.getElementById('forgot-email').value.trim();

                        try {
                            await auth.sendPasswordResetEmail(email, {
                                url: `${window.location.origin}/`
                            });
                            forgotSuccessMessage.textContent = 'Password reset email sent! Check your inbox and click the link promptly.';
                            forgotSuccessMessage.style.display = 'block';
                            forgotSuccessMessage.classList.add('show');
                            forgotErrorMessage.style.display = 'none';
                            forgotPasswordForm.reset();
                        } catch (error) {
                            console.error('Password reset error:', error);
                            forgotErrorMessage.textContent = error.code === 'auth/user-not-found'
                                ? 'No user found with this email.'
                                : 'An error occurred. Please try again.';
                            forgotErrorMessage.style.display = 'block';
                            forgotErrorMessage.classList.add('show');
                            forgotSuccessMessage.style.display = 'none';
                        } finally {
                            submitButton.classList.remove('loading');
                            submitButton.disabled = false;
                        }
                    });
                }

                if (closeForgotPasswordModal) {
                    closeForgotPasswordModal.addEventListener('click', () => {
                        forgotPasswordModal.style.display = 'none';
                        forgotErrorMessage.style.display = 'none';
                        forgotSuccessMessage.style.display = 'none';
                        forgotPasswordForm.reset();
                    });

                    window.addEventListener('click', (event) => {
                        if (event.target === forgotPasswordModal) {
                            forgotPasswordModal.style.display = 'none';
                            forgotErrorMessage.style.display = 'none';
                            forgotSuccessMessage.style.display = 'none';
                            forgotPasswordForm.reset();
                        }
                    });
                }

                // Typewriter effect
                const phrases = [
                    "Protect yourself from cybercrime today.",
                    "Contra E-Crime: Your shield online.",
                    "Stay safe, stay informed, stay secure.",
                    "A righteous one deserves a precise outcome.",
                    "Empowering you against digital threats.",
                    "I’m here to help you navigate cybercrime laws.",
                    "Let’s find the legal answers you need, fast.",
                    "Your trusted guide to cybercrime justice.",
                    "Uncover the law, defeat the threat.",
                    "Defending your digital rights, step by step."
                ];
                const typewriterText = document.getElementById('typewriterText');
                let currentPhraseIndex = 0;
                let charIndex = 0;
                let isDeleting = false;

                function typeWriter() {
                    const currentPhrase = phrases[currentPhraseIndex];

                    if (!isDeleting) {
                        if (charIndex < currentPhrase.length) {
                            typewriterText.innerHTML = currentPhrase.substring(0, charIndex + 1);
                            charIndex++;
                            setTimeout(typeWriter, 100);
                        } else {
                            setTimeout(() => {
                                isDeleting = true;
                                typeWriter();
                            }, 2000);
                        }
                    } else {
                        if (charIndex > 0) {
                            typewriterText.innerHTML = currentPhrase.substring(0, charIndex - 1);
                            charIndex--;
                            setTimeout(typeWriter, 50);
                        } else {
                            isDeleting = false;
                            currentPhraseIndex = (currentPhraseIndex + 1) % phrases.length;
                            setTimeout(typeWriter, 500);
                        }
                    }
                }

                if (typewriterText) {
                    typeWriter();
                }
            } catch (error) {
                console.error('An error occurred in the script:', error);
            }
        });
    </script>
</body>
</html>